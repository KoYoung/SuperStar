<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.BorLoanInfoDao">
	<!-- 查询个人用户贷款信息 -->
	<select id="findBorLoanInfo" resultType="com.entity.BorLoanInfo">
		select
		bor.bor_name,bori.borloaninfo_id,bi.bankinfo_name,bori.contract_id,
		e.emp_name,lt.loantype_name,bori.loan_number,bori.loan_account,
		bori.loan_date,bori.loan_repayment_date,bori.loan_rate,
		lg.lmr_name
		from borrower bor,bankinfo bi,employee e,loantype lt,
		borloaninfo
		bori,loanmanagerecord lg
		where bor.bor_id=bori.bor_id and
		bi.bankinfo_id=bori.bankinfo_id
		and bori.emp_id=e.emp_id and
		bori.loan_type=lt.loantype_id
		and lg.loaninfo_id=bori.borloaninfo_id
		and bori.loaninfo_type=0
	</select>
	<!-- select * from borloaninfo </select> -->
	<!-- 添加个人用户贷款信息 -->
	<!-- <insert id="addBorLoanInfo" parameterType="com.entity.BorLoanInfo"> 
		insert into borloaninfo values(#{borId},#{bankinfoId},#{contractId},#{empId},#{loanType},#{loanNumber},#{loanAccount},#{loanDate},#{loanRepaymentDate},#{loanRate}) 
		</insert> -->

	<!-- 查询个人用户贷款信息详情 -->
	<select id="findBorLoanDetail" resultMap="borLoanDetail">
		select
		bli.borloaninfo_id, bli.bor_id,ee.emp_name,
		bli.emp_id
		,bk.bankinfo_name, bli.loan_number
		,bli.loan_account,to_char(bli.loan_date,'yyyy-MM-dd') loanDate
		,to_char(bli.loan_repayment_date,'yyyy-MM-dd') loanRepaymentDate,
		bli.loan_rate ,bli.loaninfo_type ,bor.bor_name
		,lt.loantype_name
		,ls.loanstate_name
		from
		employee ee, borLoanInfo bli,borrower
		bor,loantype lt
		,loanmanage lm,loanstate ls,bankinfo bk
		where
		bli.bor_id
		= bor.bor_id
		and bli.loan_type = lt.loantype_id
		and lm.loaninfo_id =
		bli.borloaninfo_id
		and lm.loanstate_id =
		ls.loanstate_id
		and ee.emp_id =
		bli.emp_id
		and bli.bankinfo_id = bk.bankinfo_id
	</select>
	<resultMap type="java.util.HashMap" id="borLoanDetail">
		<id property="borloaninfoId" column="borloaninfo_id" />
		<result property="borId" column="bor_id" />
		<result property="empId" column="emp_id" />
		<result property="loanNumber" column="loan_number" />
		<result property="loanAccount" column="loan_account" />
		<result property="loanDate" column="loan_date" />
		<result property="loanRepaymentDate" column="loan_repayment_date" />
		<result property="loanRate" column="loan_rate" />
		<result property="loaninfoType" column="loaninfo_type" />
		<result property="borName" column="bor_name" />
		<result property="loantypeName" column="loantype_name" />
		<result property="loanstateName" column=" LOANSTATE_NAME" />
	</resultMap>

	<select id="findBorLoanDetailsById" parameterType="int"
		resultType="java.util.HashMap">
		select bli.borloaninfo_id, bli.bor_id, bli.emp_id ,
		bli.loan_number ,bli.loan_account ,bli.loan_date
		,to_char(bli.loan_date,'yyyy-MM-dd') as loanDate
		,to_char(bli.loan_repayment_date,'yyyy-MM-dd') as loanRepaymentDate
		,bli.loaninfo_type ,lt.loantype_name,ls.loanstate_name
		,bi.bankinfo_name,bi.bankinfo_telephone,bi.bankinfo_address
		from
		borLoanInfo bli,loantype lt,loanmanage lm,
		loanstate ls,bankInfo bi
		where bli.loan_type = lt.loantype_id and bli.bankinfo_id =
		bi.bankinfo_id
		and lm.loaninfo_id = bli.borloaninfo_id and
		lm.loanstate_id =
		ls.loanstate_id and bli.borloaninfo_id=
		#{borloaninfoId}
	</select>
	<!-- select bli.borloaninfo_id, bli.bor_id, bli.emp_id , bli.loan_number 
		,bli.loan_account , bli.loan_date ,bli.loan_repayment_date, bli.loan_rate 
		, bli.borloaninfo_type , lt.loantype_name ,ls.loanstate_name,bi.bankinfo_name,bi.bankinfo_telephone,bi.bankinfo_address 
		from borLoanInfo bli,loantype lt,loanmanage lm, loanstate ls,bankInfo bi 
		where bli.loan_type = lt.loantype_id and bli.bank_id = bi.bankinfo_id and 
		lm.loaninfo_id = bli.borloaninfo_id and lm.loanstate_id = ls.loanstate_id 
		and bli.borloaninfo_id= -->
	<select id="findCusDetailsById" parameterType="int"
		resultType="java.util.HashMap">
		select
		bor_id,bor_name,bor_gender,bor_birthday,bor_nation,bor_marry,bor_cardtype,bor_cardnumber,bor_register,bor_address,bor_unit,bor_unit_address,bor_unit_phone,bor_position,bor_income,bor_phone,bor_postcode,bor_education,bor_credit,bor_photo
		from borrower where bor_id = #{borId}
	</select>
	<select id="findEmpDetailsById" parameterType="String"
		resultType="java.util.HashMap">
		select
		emp_id,emp_name,emp_gender,emp_cardnumber,emp_address,emp_education,emp_department,emp_email,emp_nation,emp_flag
		from employee where emp_id=#{empId}
	</select>
	<select id="findGuaDetailsById" parameterType="int"
		resultType="java.util.HashMap">
		select
		gua.gua_id,gua.gua_name,gua.gua_gender,gua.gua_phone,gua.gua_birthday,gua.gua_cardtype,gua.gua_cardnumber,gua.gua_register,gua.gua_address,gua.gua_unit,gua.gua_position,gua.gua_marry,gua.gua_nation,gua.gua_education,gua.gua_income
		from borloaninfo bli,guarantor gua,borgua bg where bli.borloaninfo_id
		= #{borloaninfoId} and bli.borloaninfo_id = bg.loaninfo_id and
		gua.gua_id = bg.gua_id
	</select>

	<!-- 添加个人用户贷款信息 -->
	<insert id="addBorLoanInfo" useGeneratedKeys="false"
		parameterType="com.entity.BorLoanInfo">
		insert into borloaninfo
		values(#{loaninfoType},borloaninfo_sequence.nextval,#{borId,jdbcType=VARCHAR},#{bankinfoId,jdbcType=VARCHAR},
		#{contractId,jdbcType=VARCHAR},#{empId,jdbcType=VARCHAR},
		#{loanType,jdbcType=VARCHAR},#{loanNumber,jdbcType=VARCHAR},
		#{loanAccount,jdbcType=VARCHAR},to_date(#{loanDate,jdbcType=VARCHAR},'yyyy-MM-dd'),
		to_date(#{loanRepaymentDate,jdbcType=VARCHAR},'yyyy-MM-dd'),
		#{loanRate,jdbcType=VARCHAR})
	</insert>
	<!-- 根据贷款类型，贷款编号查询贷款信息 -->
	<select id="findBorLoanInfo2" resultType="com.entity.BorLoanInfo">
		select e.emp_id,
		bw.bor_name,bk.bankinfo_name,e.emp_name
		from borloaninfo bi,borrower
		bw,bankinfo bk,employee e
		where bi.bor_id=bw.bor_id
		and
		bi.bankinfo_id=bk.bankinfo_id
		and bi.emp_id=e.emp_id
		and
		bi.loaninfo_type=0
		and bi.borloaninfo_id=#{borloaninfoId}
	</select>
	<!-- 根据贷款编号修改业务移交相关信息 -->
	<update id="modifyBorLoanInfo" parameterType="com.entity.BorLoanInfo">
		update borloaninfo
		set emp_id=#{0}
		where borloaninfo_id=#{1} and loaninfo_type=0
	</update>

	<!-- 添加一条债款管理记录 -->
	<insert id="addLoanManageRecordMap" parameterType="java.util.HashMap">
		insert into
		loanmanagerecord
		(lmr_id,loaninfo_id,emp_id,lmr_date,lmr_name) values
		(lmr_sequence.nextval,#{borloaninfoId,jdbcType=VARCHAR},#{empId,jdbcType=VARCHAR},to_char(sysdate,'yyyy-MM-dd'),0)
	</insert>
	<!-- 修改贷款状态 -->
	<update id="modifyLoanStateMap" parameterType="java.util.HashMap">
		update loanmanage
		set loanstate_id = #{loanState,jdbcType=VARCHAR} where
		loaninfo_id =
		#{borloaninfoId,jdbcType=VARCHAR}
	</update>
	<select id="findBorSearch" resultType="java.util.HashMap"
		parameterType="java.util.HashMap">
		select
		bli.borloaninfo_id,
		bli.bor_id,ee.emp_name,
		bli.emp_id ,
		bli.loan_number
		,bli.loan_account
		,to_char(bli.loan_date,'yyyy-MM-dd')
		loanDate
		,to_char(bli.loan_repayment_date,'yyyy-MM-dd')
		loanRepaymentDate,
		bli.loan_rate
		,bli.loaninfo_type ,
		bor.bor_name
		,lt.loantype_name
		,ls.loanstate_name
		from
		employee ee,
		borLoanInfo bli,
		borrower
		bor,loantype
		lt,loanmanage lm,loanstate ls,bankinfo bk
		<where>
			bli.bor_id = bor.bor_id
			and bli.loan_type = lt.loantype_id
			and
			lm.loaninfo_id = bli.borloaninfo_id
			and lm.loanstate_id =
			ls.loanstate_id
			and ee.emp_id = bli.emp_id
			and bli.bankinfo_id =
			bk.bankinfo_id
			<if test="borName!=null and borName!=''">
				and bor.bor_name like '%' || '${borName}' ||'%'
			</if>
			<if test="empName!=null and empName!=''">
				and ee.employee like '%' || '${empName}' ||'%'
			</if>
			<if test="contractId!=null and contractId!=''">
				and bli.contract_id like '%' || '${contractId}' || '%'
			</if>
			<if test="!(loanStateId.length()>5)">
				and lm.loanstate_id = #{loanStateId,jdbcType=VARCHAR}
			</if>
			<if test="!(bankId.length()>5)">
				and bli.bankinfo_id = #{bankId,jdbcType=VARCHAR}
			</if>
			<choose>
				<when test="dateFrom!=null and dateFrom!=''">
					and bli.loan_repayment_date between
					to_date('${dateFrom}','yyyy/MM/dd')
				</when>
				<otherwise>
					and bli.loan_repayment_date between
					to_date('1900-01-01','yyyy/MM/dd')
				</otherwise>
			</choose>
			<choose>
				<when test="dateTo!=null and dateTo!=''">
					and to_date('${dateTo}','yyyy/MM/dd')
				</when>
				<otherwise>
					and to_date('2100-12-31','yyyy/MM/dd')
				</otherwise>
			</choose>
		</where>
	</select>

	<select id="findTestDemo" resultMap="demoMap">
		
	</select>
	<resultMap type="java.util.HashMap" id="demoMap">
		<id property="com_id" column="com_id" />
		<collection property="repaymentinfos">
			<id property="repay_id" column="repay_id" />
			<result property="loaninfo_id" column="loaninfo_id" />
			<result property="emp_id" column="emp_id" />
			<result property="repay_date" column="repay_date" />
			<result property="repay_type" column="repay_type" />
			<result property="repay_comment" column="repay_comment" />
			<result property="repay_number" column="repay_number" />
		</collection>
	</resultMap>
</mapper>